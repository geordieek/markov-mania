<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Markov Chain Learning & Generation Demo</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
      }

      .section {
        margin-bottom: 40px;
        padding: 20px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        background: #f9f9f9;
      }

      .section h2 {
        color: #4a5568;
        margin-top: 0;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
      }

      .demo-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      label {
        font-weight: bold;
        color: #2d3748;
      }

      input,
      select,
      textarea,
      button {
        padding: 10px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:disabled {
        background: #a0aec0;
        cursor: not-allowed;
        transform: none;
      }

      .learning-visualization {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        min-height: 200px;
      }

      .state-node {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        margin: 5px;
        font-weight: bold;
      }

      .transition-arrow {
        display: inline-block;
        margin: 0 10px;
        font-size: 20px;
        color: #4a5568;
      }

      .probability {
        font-size: 12px;
        color: #666;
        margin-left: 5px;
      }

      .generation-output {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        font-family: "Courier New", monospace;
        font-size: 16px;
        line-height: 1.6;
      }

      .note {
        display: inline-block;
        background: #48bb78;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        margin: 2px;
        font-weight: bold;
      }

      .rhythm {
        display: inline-block;
        background: #ed8936;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        margin: 2px;
        font-size: 12px;
      }

      .step-by-step {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }

      .step {
        margin: 10px 0;
        padding: 10px;
        background: #f7fafc;
        border-left: 4px solid #667eea;
        border-radius: 4px;
      }

      .step-number {
        font-weight: bold;
        color: #667eea;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .stat-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
      }

      .stat-label {
        color: #4a5568;
        margin-top: 5px;
      }

      .error {
        background: #fed7d7;
        color: #c53030;
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
      }

      .success {
        background: #c6f6d5;
        color: #2f855a;
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
      }

      .hidden {
        display: none;
      }

      .loading {
        text-align: center;
        color: #4a5568;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .demo-controls {
          grid-template-columns: 1fr;
        }

        .stats {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸŽµ Markov Chain Learning & Generation Demo</h1>

      <!-- Learning Section -->
      <div class="section">
        <h2>1. How Markov Chains Learn</h2>
        <p>
          Markov chains learn by analyzing sequences to find patterns in how states transition from
          one to another.
        </p>

        <div class="demo-controls">
          <div class="control-group">
            <label for="trainingData">Training Data (one sequence per line):</label>
            <textarea
              id="trainingData"
              rows="6"
              placeholder="C4 D4 E4 F4 G4 A4 B4 C5
G4 A4 B4 C5 D5 E5 F#5 G5
F4 G4 A4 Bb4 C5 D5 E5 F5"
            ></textarea>
          </div>

          <div class="control-group">
            <label for="order">Order (context length):</label>
            <select id="order">
              <option value="1">1 (previous element only)</option>
              <option value="2" selected>2 (previous two elements)</option>
              <option value="3">3 (previous three elements)</option>
            </select>

            <label for="smoothing">Smoothing:</label>
            <input type="range" id="smoothing" min="0" max="1" step="0.1" value="0.1" />
            <span id="smoothingValue">0.1</span>
          </div>
        </div>

        <button id="learnBtn">Learn from Training Data</button>

        <div id="learningProgress" class="hidden">
          <h3>Learning Progress:</h3>
          <div id="learningSteps" class="step-by-step"></div>
        </div>

        <div id="learnedModel" class="hidden">
          <h3>Learned Model:</h3>
          <div id="modelVisualization" class="learning-visualization"></div>
        </div>
      </div>

      <!-- Generation Section -->
      <div class="section">
        <h2>2. How to Generate Specific Outputs</h2>
        <p>
          Once trained, you can generate sequences using various controls to influence the output.
        </p>

        <div class="demo-controls">
          <div class="control-group">
            <label for="sequenceLength">Sequence Length:</label>
            <input type="number" id="sequenceLength" value="8" min="1" max="32" />

            <label for="startContext">Starting Context (optional):</label>
            <input type="text" id="startContext" placeholder="C4 D4 (space-separated)" />
          </div>

          <div class="control-group">
            <label for="temperature">Temperature (randomness):</label>
            <input type="range" id="temperature" min="0.1" max="2" step="0.1" value="1.0" />
            <span id="temperatureValue">1.0 (Normal)</span>

            <label for="generationType">Generation Type:</label>
            <select id="generationType">
              <option value="random">Random (creative)</option>
              <option value="deterministic">Deterministic (predictable)</option>
              <option value="constrained">Constrained (specific start)</option>
            </select>
          </div>
        </div>

        <button id="generateBtn" disabled>Generate Sequence</button>

        <div id="generationOutput" class="hidden">
          <h3>Generated Sequence:</h3>
          <div id="generatedSequence" class="generation-output"></div>

          <h3>Generation Process:</h3>
          <div id="generationSteps" class="step-by-step"></div>
        </div>
      </div>

      <!-- Statistics Section -->
      <div class="section">
        <h2>3. Model Statistics</h2>
        <div id="modelStats" class="stats">
          <div class="stat-card">
            <div class="stat-value" id="totalStates">-</div>
            <div class="stat-label">Total States</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalTransitions">-</div>
            <div class="stat-label">Total Transitions</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgTransitions">-</div>
            <div class="stat-label">Avg Transitions/State</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="deterministicStates">-</div>
            <div class="stat-label">Deterministic States</div>
          </div>
        </div>
      </div>

      <!-- Musical Application Section -->
      <div class="section">
        <h2>4. Musical Application</h2>
        <p>
          This demonstrates how the learning process applies to musical sequences, capturing melodic
          and rhythmic patterns.
        </p>

        <div class="demo-controls">
          <div class="control-group">
            <label for="musicalStyle">Musical Style:</label>
            <select id="musicalStyle">
              <option value="classical">Classical (scales and arpeggios)</option>
              <option value="jazz">Jazz (chromatic and extended)</option>
              <option value="blues">Blues (pentatonic patterns)</option>
              <option value="custom">Custom (use training data above)</option>
            </select>
          </div>

          <div class="control-group">
            <label for="includeRhythm">Include Rhythm:</label>
            <input type="checkbox" id="includeRhythm" checked />

            <label for="musicalKey">Musical Key:</label>
            <select id="musicalKey">
              <option value="C">C Major</option>
              <option value="G">G Major</option>
              <option value="F">F Major</option>
              <option value="Am">A Minor</option>
              <option value="Dm">D Minor</option>
            </select>
          </div>
        </div>

        <button id="generateMusicalBtn" disabled>Generate Musical Sequence</button>

        <div id="musicalOutput" class="hidden">
          <h3>Generated Musical Sequence:</h3>
          <div id="musicalSequence" class="generation-output"></div>
          <div id="musicalRhythm" class="generation-output"></div>
        </div>
      </div>
    </div>

    <script type="module">
      // Import the Markov chain classes
      import { MarkovChain } from "../dist/core/MarkovChain.js";
      import { MusicMarkovChain } from "../dist/music/MusicMarkovChain.js";

      // DOM elements
      const learnBtn = document.getElementById("learnBtn");
      const generateBtn = document.getElementById("generateBtn");
      const generateMusicalBtn = document.getElementById("generateMusicalBtn");
      const trainingDataEl = document.getElementById("trainingData");
      const orderEl = document.getElementById("order");
      const smoothingEl = document.getElementById("smoothing");
      const smoothingValueEl = document.getElementById("smoothingValue");
      const sequenceLengthEl = document.getElementById("sequenceLength");
      const startContextEl = document.getElementById("startContext");
      const temperatureEl = document.getElementById("temperature");
      const temperatureValueEl = document.getElementById("temperatureValue");
      const generationTypeEl = document.getElementById("generationType");
      const musicalStyleEl = document.getElementById("musicalStyle");
      const includeRhythmEl = document.getElementById("includeRhythm");
      const musicalKeyEl = document.getElementById("musicalKey");

      // State
      let markovChain = null;
      let musicChain = null;
      let isTrained = false;

      // Initialize
      function init() {
        // Set up event listeners
        learnBtn.addEventListener("click", learnFromData);
        generateBtn.addEventListener("click", generateSequence);
        generateMusicalBtn.addEventListener("click", generateMusicalSequence);

        smoothingEl.addEventListener("input", updateSmoothingValue);
        temperatureEl.addEventListener("input", updateTemperatureValue);
        generationTypeEl.addEventListener("change", updateGenerationType);
        musicalStyleEl.addEventListener("change", loadMusicalStyle);

        // Load default training data
        loadDefaultTrainingData();
      }

      function loadDefaultTrainingData() {
        const defaultData = `C4 D4 E4 F4 G4 A4 B4 C5
G4 A4 B4 C5 D5 E5 F#5 G5
F4 G4 A4 Bb4 C5 D5 E5 F5
D4 E4 F#4 G4 A4 B4 C#5 D5`;
        trainingDataEl.value = defaultData;
      }

      function updateSmoothingValue() {
        smoothingValueEl.textContent = smoothingEl.value;
      }

      function updateTemperatureValue() {
        const temp = parseFloat(temperatureEl.value);
        let displayText = temp.toString();
        if (temp < 0.5) displayText += " (Low)";
        else if (temp > 1.5) displayText += " (High)";
        else displayText += " (Normal)";
        temperatureValueEl.textContent = displayText;
      }

      function updateGenerationType() {
        const type = generationTypeEl.value;
        if (type === "deterministic") {
          temperatureEl.value = "0.1";
          updateTemperatureValue();
        } else if (type === "random") {
          temperatureEl.value = "1.5";
          updateTemperatureValue();
        }
      }

      function loadMusicalStyle() {
        const style = musicalStyleEl.value;
        let trainingData = "";

        switch (style) {
          case "classical":
            trainingData = `C4 E4 G4 C5 G4 E4 C4
D4 F4 A4 D5 A4 F4 D4
E4 G4 B4 E5 B4 G4 E4
F4 A4 C5 F5 C5 A4 F4`;
            break;
          case "jazz":
            trainingData = `C4 D#4 F#4 A4 C5 A4 F#4 D#4
G4 B4 D5 F#5 D5 B4 G4
F4 A4 C5 E5 C5 A4 F4
Bb4 D5 F5 A5 F5 D5 Bb4`;
            break;
          case "blues":
            trainingData = `C4 Eb4 F4 F#4 G4 Bb4 C5 Bb4 G4 F#4 F4 Eb4
F4 Ab4 Bb4 B4 C5 Eb5 F5 Eb5 C5 B4 Bb4 Ab4
G4 Bb4 C5 C#5 D5 F5 G5 F5 D5 C#5 C5 Bb4`;
            break;
          case "custom":
            return; // Use existing training data
        }

        trainingDataEl.value = trainingData;
      }

      async function learnFromData() {
        try {
          learnBtn.disabled = true;
          learnBtn.textContent = "Learning...";

          const trainingText = trainingDataEl.value.trim();
          if (!trainingText) {
            throw new Error("Please enter training data");
          }

          // Parse training data
          const sequences = trainingText
            .split("\n")
            .map((line) => line.trim())
            .filter((line) => line.length > 0)
            .map((line) => line.split(/\s+/));

          // Create Markov chain
          const config = {
            order: parseInt(orderEl.value),
            smoothing: parseFloat(smoothingEl.value),
            temperature: 1.0,
          };

          markovChain = new MarkovChain(config);

          // Show learning progress
          showLearningProgress(sequences);

          // Train the chain
          markovChain.train(sequences);

          // Show learned model
          showLearnedModel();

          // Update statistics
          updateStatistics();

          isTrained = true;
          generateBtn.disabled = false;
          generateMusicalBtn.disabled = false;

          showSuccess("Successfully learned from training data!");
        } catch (error) {
          showError("Error learning: " + error.message);
        } finally {
          learnBtn.disabled = false;
          learnBtn.textContent = "Learn from Training Data";
        }
      }

      function showLearningProgress(sequences) {
        const progressEl = document.getElementById("learningProgress");
        const stepsEl = document.getElementById("learningSteps");

        progressEl.classList.remove("hidden");
        stepsEl.innerHTML = "";

        // Show step-by-step learning process
        const order = parseInt(orderEl.value);
        let stepCount = 0;

        sequences.forEach((sequence, seqIndex) => {
          const step = document.createElement("div");
          step.className = "step";
          step.innerHTML = `
                    <div class="step-number">Step ${++stepCount}:</div>
                    Processing sequence ${seqIndex + 1}: ${sequence.join(" ")}
                `;
          stepsEl.appendChild(step);

          // Show context extraction
          for (let i = 0; i <= sequence.length - order; i++) {
            const context = sequence.slice(i, i + order);
            const nextElement = sequence[i + order];

            if (nextElement) {
              const step2 = document.createElement("div");
              step2.className = "step";
              step2.innerHTML = `
                            <div class="step-number">Step ${++stepCount}:</div>
                            Context: [${context.join(", ")}] â†’ Next: ${nextElement}
                        `;
              stepsEl.appendChild(step2);
            }
          }
        });
      }

      function showLearnedModel() {
        const modelEl = document.getElementById("learnedModel");
        const vizEl = document.getElementById("modelVisualization");

        modelEl.classList.remove("hidden");

        // Get transition analysis
        const analysis = markovChain.getTransitionAnalysis();

        // Show sample transitions
        let html = "<h4>Sample Transitions:</h4>";
        analysis.sampleTransitions.forEach((transition) => {
          html += `<div style="margin: 10px 0;">`;
          html += `<span class="state-node">${transition.context}</span>`;
          html += `<span class="transition-arrow">â†’</span>`;

          transition.transitions.forEach((t) => {
            html += `<span class="state-node" style="background: #48bb78;">${t.element}</span>`;
            html += `<span class="probability">(${(t.probability * 100).toFixed(1)}%)</span>`;
          });

          html += `</div>`;
        });

        vizEl.innerHTML = html;
      }

      function updateStatistics() {
        const stats = markovChain.getStats();
        const analysis = markovChain.getTransitionAnalysis();

        document.getElementById("totalStates").textContent = stats.totalStates;
        document.getElementById("totalTransitions").textContent = stats.totalTransitions;
        document.getElementById("avgTransitions").textContent =
          stats.averageTransitionsPerState.toFixed(2);
        document.getElementById("deterministicStates").textContent = analysis.deterministicStates;
      }

      function generateSequence() {
        if (!isTrained) {
          showError("Please train the model first!");
          return;
        }

        try {
          const length = parseInt(sequenceLengthEl.value);
          const startContext = startContextEl.value.trim()
            ? startContextEl.value.split(/\s+/)
            : undefined;
          const temperature = parseFloat(temperatureEl.value);

          // Set temperature
          markovChain.setTemperature(temperature);

          // Generate sequence
          const sequence = markovChain.generate(length, startContext);

          // Show output
          showGeneratedSequence(sequence);

          // Show generation process
          showGenerationProcess(sequence, startContext);
        } catch (error) {
          showError("Error generating: " + error.message);
        }
      }

      function showGeneratedSequence(sequence) {
        const outputEl = document.getElementById("generationOutput");
        const sequenceEl = document.getElementById("generatedSequence");

        outputEl.classList.remove("hidden");

        const html = sequence.map((note) => `<span class="note">${note}</span>`).join(" ");
        sequenceEl.innerHTML = html;
      }

      function showGenerationProcess(sequence, startContext) {
        const stepsEl = document.getElementById("generationSteps");
        stepsEl.innerHTML = "";

        const order = markovChain.config.order;
        let currentContext = startContext || markovChain.getRandomStartContext();

        sequence.forEach((note, index) => {
          const step = document.createElement("div");
          step.className = "step";
          step.innerHTML = `
                    <div class="step-number">Step ${index + 1}:</div>
                    Context: [${currentContext.join(", ")}] â†’ Generated: ${note}
                `;
          stepsEl.appendChild(step);

          // Update context for next step
          currentContext = [...currentContext.slice(1), note];
        });
      }

      async function generateMusicalSequence() {
        if (!isTrained) {
          showError("Please train the model first!");
          return;
        }

        try {
          // Create music chain
          const config = {
            order: parseInt(orderEl.value),
            smoothing: parseFloat(smoothingEl.value),
            temperature: parseFloat(temperatureEl.value),
          };

          musicChain = new MusicMarkovChain(config);

          // Parse training data for musical sequences
          const trainingText = trainingDataEl.value.trim();
          const sequences = trainingText
            .split("\n")
            .map((line) => line.trim())
            .filter((line) => line.length > 0)
            .map((line) => line.split(/\s+/));

          // Create note and rhythm sequences
          const noteSequences = sequences.map((seq) => seq);
          const rhythmSequences = sequences.map(
            (seq) => seq.map(() => "4") // Default to quarter notes
          );

          // Train music chain
          musicChain.trainWithMusic(noteSequences, rhythmSequences);
          musicChain.setKey(musicalKeyEl.value);
          musicChain.setTemperature(parseFloat(temperatureEl.value));

          // Generate musical sequence
          const length = parseInt(sequenceLengthEl.value);
          const musicSequence = musicChain.generateSequence(length);

          // Show musical output
          showMusicalSequence(musicSequence);
        } catch (error) {
          showError("Error generating musical sequence: " + error.message);
        }
      }

      function showMusicalSequence(musicSequence) {
        const outputEl = document.getElementById("musicalOutput");
        const sequenceEl = document.getElementById("musicalSequence");
        const rhythmEl = document.getElementById("musicalRhythm");

        outputEl.classList.remove("hidden");

        // Show notes
        const notesHtml = musicSequence.notes
          .map((note) => {
            const noteName = getNoteName(note.pitch);
            return `<span class="note">${noteName}</span>`;
          })
          .join(" ");
        sequenceEl.innerHTML = `<strong>Notes:</strong> ${notesHtml}`;

        // Show rhythms
        const rhythmsHtml = musicSequence.notes
          .map((note) => {
            const duration = note.duration;
            const beatDuration = (60 / 120) * 1000; // 120 BPM
            let rhythm = "4";
            if (duration >= beatDuration * 4) rhythm = "1";
            else if (duration >= beatDuration * 2) rhythm = "2";
            else if (duration >= beatDuration) rhythm = "4";
            else if (duration >= beatDuration / 2) rhythm = "8";
            else if (duration >= beatDuration / 4) rhythm = "16";

            return `<span class="rhythm">${rhythm}</span>`;
          })
          .join(" ");
        rhythmEl.innerHTML = `<strong>Rhythms:</strong> ${rhythmsHtml}`;
      }

      function getNoteName(pitch) {
        const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const octave = Math.floor(pitch / 12) - 1;
        const noteName = noteNames[pitch % 12];
        return `${noteName}${octave}`;
      }

      function showError(message) {
        const errorEl = document.createElement("div");
        errorEl.className = "error";
        errorEl.textContent = message;
        document
          .querySelector(".container")
          .insertBefore(errorEl, document.querySelector(".section"));
        setTimeout(() => errorEl.remove(), 5000);
      }

      function showSuccess(message) {
        const successEl = document.createElement("div");
        successEl.className = "success";
        successEl.textContent = message;
        document
          .querySelector(".container")
          .insertBefore(successEl, document.querySelector(".section"));
        setTimeout(() => successEl.remove(), 3000);
      }

      // Initialize the demo
      init();
    </script>
  </body>
</html>
